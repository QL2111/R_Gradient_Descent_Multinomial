```{r}
library(R6)

DataPreparer <- R6::R6Class("DataPreparer",
    public = list(
        # Paramètre pour choisir l'analyse factorielle pour variables qualitatives
        use_factor_analysis = FALSE,
        threshold = 0.1,  # Seuil par défaut pour la sélection de variables
        
        # Constructeur
        initialize = function(use_factor_analysis = FALSE, threshold = 0.1) {
            self$use_factor_analysis <- use_factor_analysis
            self$threshold <- threshold
        },
        
        # Méthode pour standardiser les données quantitatives
        standardize = function(data) {
            return((data - mean(data, na.rm = TRUE)) / sd(data, na.rm = TRUE))
        },
        
        # Méthode principale pour préparer les données
        prepare_data = function(data) {
            # Identifier les variables quantitatives et qualitatives
            quantitative_vars <- sapply(data, is.numeric)
            qualitative_vars <- !quantitative_vars
            
            # Initialiser une liste pour stocker les données préparées
            prepared_list <- list()
            
            # Traitement des variables quantitatives
            if (any(quantitative_vars)) {
                quant_data <- data[, quantitative_vars, drop = FALSE]
                quant_data <- as.data.frame(lapply(quant_data, self$standardize))
                prepared_list$quantitative <- quant_data
            }
            
            # Traitement des variables qualitatives
            if (any(qualitative_vars)) {
                qual_data <- data[, qualitative_vars, drop = FALSE]
                
                if (self$use_factor_analysis) {
                    qual_data <- factor_analysis_mixed(qual_data)
                } else {
                    qual_data <- as.data.frame(model.matrix(~ . - 1, data = qual_data))
                }
                
                prepared_list$qualitative <- qual_data
            }
            
            # Combiner les données quantitatives et qualitatives
            prepared_data <- do.call(cbind, prepared_list)
            return(prepared_data)
        },
        
        # Méthode de sélection automatique des variables
        var_select = function(X, y) {
            # 1. Entraîner un modèle logistique simple pour obtenir les coefficients
            model <- glm(y ~ ., data = X, family = binomial)
            coefficients <- abs(coef(model))[-1]  # Ignorer l'interception
            
            # 2. Filtrer les variables selon le seuil
            selected_vars <- names(coefficients)[coefficients >= self$threshold]
            selected_data <- X[, selected_vars, drop = FALSE]
            
            cat("Variables sélectionnées (importance prédictive) :\n")
            print(selected_vars)
            
            return(selected_data)
        }
    )
)

# Fonction fictive pour illustrer l'AFDM - doit être remplacée par une vraie implémentation
factor_analysis_mixed <- function(data) {
    return(data.frame(matrix(rnorm(n = nrow(data) * 2), ncol = 2)))
}

```




```{r}
# Chargement des données
data(iris)
iris$Species <- as.numeric(iris$Species == "setosa")  # Exemple binaire pour glm

# Préparation des données
data_prep <- DataPreparer$new(threshold = 0.2)  # Définition d'un seuil d'importance
prepared_data <- data_prep$prepare_data(iris)

# Sélection automatique des variables
X <- prepared_data[, -ncol(prepared_data)]  # Prédicteurs
y <- iris$Species                           # Cible
selected_data <- data_prep$var_select(X, y)
print(selected_data)

```

